# 🚀 Render 合併部署指南 - 前後端一體化部署

本指南說明如何在 Render 上使用**合併部署**方案，將前後端部署在同一個 Web Service 上。

## 📋 方案說明

### 合併部署 vs 分離部署

| 特性 | 合併部署 | 分離部署 |
|------|---------|---------|
| **服務數量** | 1 個 Web Service | 2 個服務（Web Service + Static Site） |
| **成本** | 更低（只需一個服務） | 更高（兩個服務） |
| **部署複雜度** | 中等 | 較高 |
| **構建時間** | 較長（需要構建前端） | 較短（分別構建） |
| **適用場景** | 小型項目、預算有限 | 大型項目、需要獨立擴展 |

### 工作原理

1. **構建階段**：先構建前端 React 應用（生成 `Views/build` 目錄）
2. **啟動階段**：後端 Express 服務器啟動，同時服務：
   - API 路由（`/api/*`, `/server/*` 等）
   - 前端靜態文件（從 `Views/build` 目錄）
   - React Router 路由（所有非 API 請求返回 `index.html`）

---

## 🛠️ 已完成的代碼修改

### 1. ✅ 更新後端服務器 (`js_server/server.js`)

已添加以下功能：
- 靜態文件服務中間件（服務前端構建文件）
- React Router 支持（所有非 API 路由返回 `index.html`）
- 通過環境變量 `SERVE_FRONTEND` 控制是否服務前端

### 2. ✅ 創建構建腳本 (`build.js`)

已創建自動化構建腳本，會：
- 安裝前端依賴
- 構建前端應用
- 安裝後端依賴

### 3. ✅ 更新 package.json

已更新根目錄和後端的 `package.json`，添加構建和啟動命令。

---

## 📝 部署步驟

### 第一步：準備 MongoDB Atlas

1. **獲取連接字符串**
   - 登入 [MongoDB Atlas](https://www.mongodb.com/cloud/atlas)
   - 獲取連接字符串：`mongodb+srv://username:password@cluster.mongodb.net/`
   - 在 Network Access 中添加 `0.0.0.0/0` 允許所有 IP

### 第二步：在 Render 創建 Web Service

1. **登入 Render**
   - 訪問 [render.com](https://render.com)
   - 使用 GitHub 帳號登入

2. **創建新的 Web Service**
   - 點擊 "New +" → "Web Service"
   - 連接你的 GitHub 倉庫

3. **配置服務設置**

   | 設置項 | 值 | 說明 |
   |--------|-----|------|
   | **Name** | `fruit-order-system` | 服務名稱（可自定義） |
   | **Region** | `Singapore` | 選擇離你最近的區域 |
   | **Branch** | `main` 或 `master` | 你的主分支名稱 |
   | **Root Directory** | （留空） | ⚠️ **重要**：必須留空，使用根目錄 |
   | **Runtime** | `Node` | 自動檢測 |
   | **Build Command** | `node build.js` | 構建前後端 |
   | **Start Command** | `cd js_server && npm start` | 啟動後端服務器 |
   | **Instance Type** | `Free` | 免費方案 |

   ⚠️ **重要提示**：
   - **Root Directory 必須留空**，因為構建腳本需要訪問根目錄和子目錄
   - Build Command 會自動構建前端並安裝所有依賴
   - Start Command 啟動後端服務器（後端會自動服務前端文件）

4. **設置環境變量**

   在 "Environment Variables" 部分添加：

   | 變量名 | 值 | 說明 |
   |--------|-----|------|
   | `ATLAS_URL` | `mongodb+srv://username:password@cluster.mongodb.net/` | MongoDB 連接字符串（替換為實際值） |
   | `NODE_ENV` | `production` | 生產環境標識 |
   | `SERVE_FRONTEND` | `true` | ⚠️ **重要**：啟用前端服務 |
   | `PORT` | `10000` | Render 自動設置，但可以明確指定 |
   | `REACT_APP_API_URL` | （留空或設置為相對路徑） | 前端 API URL（合併部署時可以留空，使用相對路徑） |
   | `REACT_APP_GOOGLE_CLIENT_ID` | `your-google-client-id` | Google OAuth 客戶端 ID（如果使用） |

   ⚠️ **重要提示**：
   - `SERVE_FRONTEND=true` **必須設置**，否則後端不會服務前端文件
   - `REACT_APP_API_URL` 在合併部署時可以留空，因為前後端在同一域名下
   - 如果設置 `REACT_APP_API_URL`，可以使用相對路徑 `/` 或完整 URL

5. **創建並部署**
   - 點擊 "Create Web Service"
   - Render 會自動開始構建和部署
   - ⚠️ **構建時間較長**：首次部署可能需要 5-10 分鐘（需要構建前端）
   - 等待構建完成

### 第三步：驗證部署

1. **測試後端 API**
   - 訪問：`https://your-service-url.onrender.com/api/health`
   - 應該看到：`{"status":"ok","time":"..."}`

2. **測試前端**
   - 訪問：`https://your-service-url.onrender.com`
   - 應該看到前端應用界面
   - 打開瀏覽器開發者工具（F12），檢查 Console 是否有錯誤

3. **測試完整功能**
   - 嘗試登入系統
   - 測試各個功能模塊
   - 確認數據正確保存和讀取

---

## 🔧 構建過程詳解

### 構建腳本執行流程

當 Render 執行 `node build.js` 時，會按以下順序執行：

1. **檢查目錄結構**
   - 確認 `Views/` 目錄存在
   - 確認 `Views/package.json` 存在

2. **安裝前端依賴**
   ```bash
   cd Views
   npm install
   ```

3. **構建前端應用**
   ```bash
   npm run build
   ```
   - 這會創建 `Views/build` 目錄
   - 包含所有優化後的靜態文件

4. **安裝後端依賴**
   ```bash
   cd ../js_server
   npm install
   ```

5. **構建完成**
   - 前端構建文件位於 `Views/build`
   - 後端依賴已安裝
   - 準備啟動服務器

### 服務器啟動流程

當執行 `cd js_server && npm start` 時：

1. **連接數據庫**
   - 使用 `ATLAS_URL` 環境變量連接 MongoDB

2. **註冊 API 路由**
   - 所有 `/api/*` 和 `/server/*` 路由由後端處理

3. **服務靜態文件**（如果 `SERVE_FRONTEND=true`）
   - 從 `Views/build` 目錄服務靜態文件
   - 所有非 API 請求返回 `index.html`（支持 React Router）

---

## ⚠️ 重要注意事項

### 1. 環境變量設置

**必須設置的環境變量**：
- ✅ `SERVE_FRONTEND=true` - 啟用前端服務
- ✅ `ATLAS_URL` - MongoDB 連接字符串
- ✅ `NODE_ENV=production` - 生產環境標識

**可選的環境變量**：
- `REACT_APP_API_URL` - 在合併部署時可以留空（使用相對路徑）
- `REACT_APP_GOOGLE_CLIENT_ID` - 如果使用 Google 登入

### 2. Root Directory 設置

⚠️ **Root Directory 必須留空**！

如果設置了 Root Directory（如 `js_server`），構建腳本將無法訪問 `Views/` 目錄，導致構建失敗。

### 3. 構建時間

合併部署的構建時間較長：
- **首次部署**：5-10 分鐘（需要安裝所有依賴並構建前端）
- **後續更新**：3-5 分鐘（如果只修改後端代碼，前端可能使用緩存）

### 4. 免費方案限制

- **休眠機制**：15 分鐘無活動後會自動休眠
- **喚醒時間**：首次訪問休眠的服務需要等待 15-30 秒
- **構建時間限制**：免費方案有構建時間限制，如果構建時間過長可能失敗

### 5. 前端 API 配置

在合併部署中，前端和後端在同一域名下，所以：
- `REACT_APP_API_URL` 可以留空（前端會使用相對路徑）
- 或者設置為 `/`（相對路徑）
- 或者設置為完整的服務 URL（如 `https://your-service.onrender.com`）

查看 `Views/src/components/GetAPI/Getapi.js`，它會自動處理：
- 如果設置了 `REACT_APP_API_URL`，使用該值
- 否則在生產環境中使用相對路徑

---

## 🐛 常見問題排查

### 問題 1：構建失敗 - 找不到 Views 目錄

**錯誤信息**：`❌ 錯誤：找不到 Views 目錄`

**解決方案**：
- 檢查 Root Directory 是否留空（必須留空）
- 確認 GitHub 倉庫包含 `Views/` 目錄
- 檢查分支名稱是否正確

### 問題 2：前端無法訪問 - 404 錯誤

**症狀**：訪問服務 URL 時顯示 404 或無法找到頁面

**解決方案**：
1. 檢查環境變量 `SERVE_FRONTEND` 是否設置為 `true`
2. 查看構建日誌，確認前端是否成功構建（應該有 `Views/build` 目錄）
3. 檢查後端日誌，確認服務器是否正常啟動
4. 確認 `Views/build/index.html` 文件存在

### 問題 3：API 請求失敗

**症狀**：前端可以訪問，但 API 請求失敗

**解決方案**：
1. 測試後端健康檢查：`https://your-service.onrender.com/api/health`
2. 檢查瀏覽器開發者工具的 Network 標籤，查看 API 請求的狀態
3. 檢查後端日誌，查看是否有錯誤信息
4. 確認 MongoDB 連接正常（查看後端日誌）

### 問題 4：React Router 路由無法工作

**症狀**：直接訪問路由（如 `/orders`）時顯示 404

**解決方案**：
- 這是正常的，因為後端需要正確配置 React Router 支持
- 確認 `server.js` 中的靜態文件服務代碼已正確添加
- 確認 `SERVE_FRONTEND=true` 環境變量已設置
- 檢查後端日誌，確認靜態文件服務中間件是否啟用

### 問題 5：構建時間過長導致超時

**症狀**：構建過程在 Render 上超時

**解決方案**：
1. 檢查構建日誌，找出耗時的操作
2. 考慮使用 `.npmrc` 文件優化 npm 安裝
3. 考慮升級到付費方案（有更長的構建時間限制）
4. 檢查是否有不必要的依賴可以移除

### 問題 6：環境變量未生效

**症狀**：前端無法讀取環境變量（如 `REACT_APP_API_URL`）

**解決方案**：
1. 確認環境變量名稱正確（React 環境變量必須以 `REACT_APP_` 開頭）
2. 修改環境變量後，需要重新部署服務
3. 檢查構建日誌，確認環境變量是否在構建時可用
4. 注意：環境變量在構建時注入，運行時無法修改

---

## 📊 部署檢查清單

部署完成後，使用以下清單確認一切正常：

### 構建階段
- [ ] 構建腳本成功執行
- [ ] 前端依賴安裝成功
- [ ] 前端構建成功（`Views/build` 目錄存在）
- [ ] 後端依賴安裝成功
- [ ] 沒有構建錯誤或警告

### 運行階段
- [ ] 後端服務器成功啟動
- [ ] MongoDB 連接成功（查看後端日誌）
- [ ] 健康檢查端點正常：`/api/health`
- [ ] 前端可以訪問（根路徑 `/`）
- [ ] 靜態文件可以加載（CSS、JS、圖片等）

### 功能測試
- [ ] 前端界面正常顯示
- [ ] 瀏覽器控制台無錯誤
- [ ] API 請求成功
- [ ] 用戶可以登入
- [ ] 數據可以正確讀取和保存
- [ ] React Router 路由正常工作

---

## 🔄 更新部署

當你需要更新代碼時：

1. **推送代碼到 GitHub**
   ```bash
   git add .
   git commit -m "更新描述"
   git push origin main
   ```

2. **Render 自動部署**
   - Render 會自動檢測到新的提交
   - 開始新的構建和部署流程
   - 可以在 Render 儀表板查看構建進度

3. **手動觸發部署**（可選）
   - 在 Render 服務頁面，點擊 "Manual Deploy"
   - 選擇要部署的分支和提交

---

## 💡 優化建議

### 1. 減少構建時間

- 使用 `.npmrc` 文件配置 npm 鏡像
- 考慮使用 `npm ci` 代替 `npm install`（需要 `package-lock.json`）
- 移除不必要的依賴

### 2. 優化前端構建

- 檢查 `Views/package.json` 中的依賴
- 移除未使用的依賴
- 考慮使用構建緩存（Render 付費方案）

### 3. 監控和日誌

- 定期檢查 Render 的日誌
- 設置錯誤監控（如 Sentry）
- 監控服務器性能和響應時間

---

## 📚 相關文檔

- **分離部署指南**：查看 `部署說明.md` 或 `RENDER_DEPLOYMENT_GUIDE.md`
- **快速參考**：查看 `RENDER_QUICK_START.md`
- **Render 官方文檔**：https://render.com/docs
- **MongoDB Atlas 文檔**：https://docs.atlas.mongodb.com/

---

## 🎉 完成！

恭喜！你已經成功使用合併部署方案將應用部署到 Render。

**優點**：
- ✅ 只需一個服務，成本更低
- ✅ 部署更簡單，只需配置一個服務
- ✅ 前後端在同一域名下，無需處理 CORS

**注意事項**：
- ⚠️ 構建時間較長
- ⚠️ 需要確保 `SERVE_FRONTEND=true` 環境變量已設置
- ⚠️ Root Directory 必須留空

如果遇到任何問題，請參考「常見問題排查」部分或查看 Render 的構建和運行日誌。

祝你部署順利！🚀

